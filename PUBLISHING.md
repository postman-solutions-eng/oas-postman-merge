# Publishing to Postman

This guide walks you through setting up automatic publishing of your merged collections to Postman.

## Overview

After the OAS merge tool updates your collection locally (Step 1), you can automatically push those changes to Postman (Step 2). This creates a seamless workflow:

```
OpenAPI Spec â†’ Merge Tool â†’ Local Collection â†’ Postman API â†’ Live in Postman
```

## Quick Setup (Recommended)

The easiest way to configure publishing is with our interactive wizard:

```bash
npm run setup:publish
```

The wizard will:
1. âœ… Validate your Postman API key
2. âœ… List your workspaces and collections
3. âœ… Help you select the target collection
4. âœ… Create `.env.local` for local testing
5. âœ… Provide GitHub Actions setup instructions

## Manual Setup

### Step 1: Get a Postman API Key

1. Go to [Postman API Keys](https://postman.co/settings/me/api-keys)
2. Click **Generate API Key**
3. Name it something like "OAS Merge Tool"
4. Copy the key immediately (you won't see it again!)

> âš ï¸ **Security Note:** Treat your API key like a password. Never commit it to version control.

### Step 2: Find Your Collection UID

The collection UID is in the format `{userId}-{collectionId}`.

**Option A: From Postman App**
1. Open your collection in Postman
2. Click the `...` menu
3. Select **View Info** (or press `Cmd/Ctrl + Shift + I`)
4. Copy the **Collection ID**

**Option B: From the API**
```bash
curl -s -H "X-Api-Key: YOUR_API_KEY" \
  https://api.getpostman.com/collections | jq '.collections[] | {name, uid}'
```

### Step 3: Configure Environment

**For Local Testing:**

Create `.env.local` in your project root:
```bash
# Copy the template
cp config/publish.env.example .env.local

# Edit with your values
nano .env.local
```

Contents:
```env
POSTMAN_API_KEY=your-key-here
WORKING_COLLECTION_UID=12345678-abcd-1234-efgh-567890123456
```

**For GitHub Actions:**

Add secrets and variables to your repository:

1. Go to `Settings â†’ Secrets and variables â†’ Actions`

2. Add **Secret** (for sensitive values):
   - Name: `POSTMAN_API_KEY`
   - Value: Your API key

3. Add **Variable** (for non-sensitive values):
   - Name: `WORKING_COLLECTION_UID`
   - Value: Your collection UID

> ðŸ’¡ **Why separate?** Secrets are encrypted and hidden in logs. Variables are visible but not sensitive.

## Usage

### Local Testing

```bash
# Dry run - validates everything without making changes
npm run publish:test

# Publish to Postman
npm run publish
```

### CI/CD Integration

The included GitHub Actions workflow (`.github/workflows/oas-merge.yaml`) automatically publishes when:
- A PR with "OAS merge:" in the title is merged to `main`
- The merge job completed successfully

Workflow snippet:
```yaml
publish:
  if: github.event_name == 'push' && contains(github.event.head_commit.message, 'OAS merge:')
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - run: npm ci
    - run: npm run publish
  env:
    POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
    WORKING_COLLECTION_UID: ${{ vars.WORKING_COLLECTION_UID }}
```

## Troubleshooting

### "Invalid API key"

- Check that your key hasn't expired
- Generate a new key at https://postman.co/settings/me/api-keys
- Make sure there are no extra spaces when copying

### "Collection not found"

- Verify the collection UID format: `{userId}-{uuid}`
- Ensure you have access to the collection
- Check if the collection was deleted or moved

### "403 Forbidden"

- You don't have write access to the collection
- You must be the owner or have Editor role
- Team collections may require specific permissions

### "Network error"

- Check your internet connection
- Postman API may be temporarily unavailable
- Check [Postman Status](https://status.postman.com)

## Best Practices

### 1. Always Test First

```bash
# Always do a dry run before publishing
npm run publish:test
```

### 2. Use Branch Protection

Configure your repo to require:
- PR reviews before merge
- Passing CI checks

This ensures only reviewed changes get published.

### 3. Review the Changelog

Before merging, review the semantic changelog generated by the merge tool:
- Check for unexpected retirements
- Verify new endpoints look correct
- Confirm no curated content was lost

### 4. Keep a Backup

The workflow creates a backup branch before each merge. You can restore from:
- `backup/before-merge-{date}` branches
- Git history

### 5. Monitor Postman

After publishing, verify in Postman:
- Collection updated correctly
- No broken requests
- Variables resolved properly

## Security Considerations

### API Key Permissions

Your Postman API key has access to:
- Read/write collections
- Read/write environments
- View workspace details

Consider:
- Using a dedicated API key for CI/CD
- Rotating keys periodically
- Monitoring API key usage in Postman

### Repository Secrets

GitHub Secrets are:
- Encrypted at rest
- Never exposed in logs
- Only available to workflows

Never:
- Print secrets in workflow logs
- Commit secrets to code
- Share secrets in issues/PRs

## Advanced Configuration

### Custom Collection Path

Publish a different collection file:
```bash
node scripts/publish.js --collection path/to/my-collection.json
```

### Verbose Output

See detailed information:
```bash
node scripts/publish.js --verbose
```

### Non-Interactive Mode

For CI/CD pipelines, the script automatically skips confirmation prompts when:
- `CI=true` environment variable is set
- `GITHUB_ACTIONS=true` is set

## API Reference

The publish script uses the Postman API:

```
PUT https://api.getpostman.com/collections/{collectionUid}
```

Request body:
```json
{
  "collection": {
    "info": { "name": "...", "schema": "..." },
    "item": [...]
  }
}
```

Response:
```json
{
  "collection": {
    "id": "...",
    "name": "...",
    "uid": "..."
  }
}
```

See [Postman API Documentation](https://learning.postman.com/docs/developer/intro-api/) for more details.

---

## Next Steps

1. âœ… Run `npm run setup:publish` to configure
2. âœ… Test with `npm run publish:test`
3. âœ… Add secrets to GitHub
4. ðŸŽ‰ Your collections will auto-publish on merge!

Questions? Open an issue or check the [main README](README.md).
