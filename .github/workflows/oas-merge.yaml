name: OAS → Working Collection (PR + optional publish)

on:
  push:
    branches:
      - "**"
    paths:
      - "openapi/demo-v2.yaml"
      - "collections/working.json"
  pull_request:
    paths:
      - "openapi/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    # Only run when OpenAPI files change (not when working.json changes from PR merge)
    if: contains(github.event.head_commit.modified, 'openapi/') || contains(github.event.head_commit.added, 'openapi/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: |
          npm ci || npm i
          npm i -g openapi-to-postmanv2@4.3.0

      - name: Build Reference collections
        run: |
          mkdir -p ref
          for f in openapi/*.*; do
            base=$(basename "$f")
            out="ref/${base%.*}.postman_collection.json"
            openapi2postmanv2 -s "$f" -o "$out" -p
          done

      - name: Merge Reference → Working (write merged artifact)
        run: |
          node scripts/merge.js \
            --config config/merge.config.yaml \
            --working collections/working.json \
            --refdir ref \
            --out collections/working.merged.json

      # Generate changelog BEFORE copy/normalize so it reflects real adds/retires.
      - name: Generate changelog (pre-normalize)
        run: |
          node scripts/enhanced-changelog.js \
            --before collections/working.json \
            --after  collections/working.merged.json \
            --out CHANGELOG.md

      - name: Copy merged over Working (stage for PR)
        run: cp collections/working.merged.json collections/working.json

      - name: Normalize for stable diffs
        run: node scripts/normalize.js collections/working.json

      - name: Canonical JSON key order (global, stable)
        run: |
          jq -S . collections/working.json > collections/working.sorted.json
          mv collections/working.sorted.json collections/working.json

      - name: Commit and open/update PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "OAS merge: update Working collection"
          title: "OAS merge: update Working collection"
          body-path: CHANGELOG.md
          branch: oas-merge/update-working
          add-paths: |
            collections/working.json
            CHANGELOG.md

  publish:
    # Only run when working.json changes (indicating PR merge) on main/video-demo branches
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/video-demo') && (contains(github.event.head_commit.modified, 'collections/working.json') || contains(github.event.head_commit.added, 'collections/working.json'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci || npm i

      - name: Push merged Working back to Postman
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          WORKING_COLLECTION_UID: ${{ vars.WORKING_COLLECTION_UID }}
        run: |
          FILE="collections/working.json"
          jq -n --argjson c "$(cat "$FILE")" '{collection:$c}' > payload.json
          curl -sS -X PUT -H "X-Api-Key: $POSTMAN_API_KEY" -H "Content-Type: application/json" \
            -d @payload.json "https://api.getpostman.com/collections/$WORKING_COLLECTION_UID" \
            | jq -r '.'